#!/bin/bash

# Configure directories
build_dir=$1
cache_basedir=$2

# Resolve node version using semver.io
node_version=$(curl --silent --get --data-urlencode "range=${semver_range}" https://semver.io/node/resolve)
npm_version=$(curl --silent --get --data-urlencode "range=${npm_semver_range}" https://semver.io/npm/resolve)

check_node(){
  # Check if we have latest node in cache
  if [ -f $cache_basedir/node/version ]; then
    node_version_cached=$(cat $cache_basedir/node/version | xargs)
    echo $node_version_cached
    if [ "$node_version_cached" != "$node_version" ]; then
      echo "Installing newer version of node. Discarding cached version."
      install_node
    else
      echo "Node found in cache"
      # Move to vendor folder
      mkdir -p $build_dir/vendor/node
      cp -R $cache_basedir/node $build_dir/vendor/
      ls $build_dir/vendor/node
    fi
  else
    install_node
  fi

  PATH=$PATH:$build_dir/vendor/node/bin

  echo "Building runtime environment"
  mkdir -p $build_dir/.profile.d
  echo "export PATH=\"\$HOME/vendor/node/bin:\$HOME/bin:\$HOME/node_modules/.bin:\$PATH\";" > $build_dir/.profile.d/nodejs.sh
}

install_node(){
  # Download node from Heroku's S3 mirror of nodejs.org/dist
  echo "Downloading and installing node"
  node_url="http://s3pository.heroku.com/node/v$node_version/node-v$node_version-linux-x64.tar.gz"
  curl $node_url -s -o - | tar xzf - -C $build_dir


  # Move node (and npm) into ./vendor and make them executable
  mv $build_dir/node-v$node_version-linux-x64 $build_dir/vendor/node
  chmod +x $build_dir/vendor/node/bin/*

  # Save to cache too
  mkdir -p $cache_basedir/node
  cp -R $build_dir/vendor/node $cache_basedir/
  echo $node_version > $cache_basedir/node/version
  ls -l $cache_basedir/node
}




# Move app to a child folder (including any hidden files (dotfiles))
cd $build_dir
mkdir -p app
shopt -s extglob dotglob
mv !(app) app
shopt -u dotglob


mkdir -p $build_dir/vendor

check_node

# Install zero
echo "Installing Zero"
mkdir -p $build_dir/vendor/zero
npm i --prefix $build_dir/vendor/zero zero -g
# ls -l $build_dir/vendor/zero/bin
PATH=$PATH:$build_dir/vendor/zero/bin
echo "export PATH=\"\$HOME/vendor/zero/bin:\$PATH\";" > $build_dir/.profile.d/zero.sh

# check if Procfile exists
# if [ -f $build_dir/app/Procfile ]; then
#   echo "Found Procfile"
# else
#   echo "web: DEBUG=core NODE_ENV=production zero" | tee $build_dir/app/Procfile
# fi

echo "web: NODE_ENV=production zero app" | tee $build_dir/Procfile


cd $build_dir/app

# Install Zero and other packages
if [ -f $build_dir/package.json ]; then
  echo "Installing NPM Packages"
  npm i
fi

# Build
echo "Building App with Zero"
PARCEL_WORKERS=1
zero build $build_dir/app
